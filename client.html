<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<meta charset="utf-8">
	<title>Xchat | Xapp.com</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
		integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD" crossorigin="anonymous">
</head>
<style>
	body{
		background-color: #d8dbe2;
		background-position: center center;
		background-repeat: no-repeat;
		background-attachment: fixed;
		background-size: cover;
		background-image: 
		radial-gradient(circle at 0 100%, #1b1b1e, #373f51, #58a4b0, #a9bcd0, #d8dbe2);
	}

	.account {
		cursor: pointer;
	}

	.alert {
		width: fit-content;
		min-width: 25%;
		max-width: 75%;
	}

	.contact-initials{
		font-size: 1.5rem;
		width: 2em;
		height: 2em;
		line-height: 2em;
		text-align: center;
	}
</style>

<body>

	<div class="container text-white">
		
		<div class="row gx-1">

			<!-- section left -->
			<div class="section-left col-sm-5 col-md-4 py-1">
				
				<!-- logo, contact input -->
				<div class="d-flex">
					<i class="bi fs-4 bi-twitter-x px-2"></i>
					<input id="new-contact" class="form-control" type="text" placeholder="Search a new contact..." />
				</div>
				
				<!--contact list -->
				<div class="contact-list">
					
					<!-- contact item -->
					<div class="contact-item d-flex align-items-center bg-dark p-2 mt-1 rounded border-start border-success border-5">
						<span class="contact-initials me-3 bg-light rounded-circle text-dark">MF</span>
						<span class="contact-name">Morgan Freeman</span>
					</div>
					<!-- contact item -->
					<div class="contact-item d-flex align-items-center bg-dark bg-opacity-50 p-2 mt-1 rounded border-start border-secondary border-5">
						<span class="contact-initials me-3 bg-light rounded-circle text-dark">D</span>
						<span class="contact-name">Dixon</span>
					</div>
				
				</div> <!-- contact-list -->
			
			</div> <!-- section-left -->


			<!-- right block -->
			<div class="section-right d-flex flex-column col-sm-7 col-md-8 vh-100 py-1">
				
				<!--секция с тем с кем ведешь беседы-->
				<div class="d-flex align-items-center justify-content-between bg-dark rounded-top p-2 border-start border-success border-5">
					
					<!--див показывает где человек с которым общаешься-->
					<div class="contact-item d-flex align-items-center">
						<span class="contact-initials me-3 bg-light rounded-circle text-dark">MF</span>
						<span class="contact-name">Morgan Freeman</span>
					</div>
					
					<!--кнопки аудио и видео вызовов-->
					<div>
						<button type="button" class="btn btn-secondary btn-sm">
							<i class="bi bi-telephone"></i>
						</button>
						<button type="button" class="btn btn-secondary btn-sm">
							<i class="bi bi-camera-video"></i>
						</button>
					</div>
				</div>

				
				<!-- messages -->
				<div class="messages overflow-auto flex-fill p-2 bg-dark bg-opacity-50 my-1" id="messages">
				</div>

				
				<!--див отправки сообщений-->
				<div>
					<form class="d-flex rounded-bottom overflow-auto" action="" id="form">
						<!-- прикрепить документ -->
						<button class="btn btn-light rounded-0">
							<i class="bi bi-paperclip"></i>
						</button>
	
						<input id="input"
							class="form-control rounded-0"
							type="text"
							placeholder="Type a message"
							autocomplete="off" />
						
						<button class="btn btn-dark rounded-0">Send</button>
					</form>
				</div>

			</div>

		</div>
	</div>

	<!--можно перенестив отдельный файл -->
	<script>

		window.addEventListener('load', function() {
			const section_left = document.querySelector('.section-left');
			const section_right = document.querySelector('.section-right');
			const accounts_sections = document.querySelector('.accounts');
			const BTN_SECTION_RIGHT_NONE = document.querySelector('.btn-section-rigth-none');

			// кнопка скрывающая правую секцию и показывающая левую (появляется кнопка только после того когда экран < 576)
			BTN_SECTION_RIGHT_NONE.addEventListener('click', function() {
				section_right.classList.add('d-none');
				section_left.classList.remove('d-none');
			})

			// click on account left section
			let last_clicked_account = null;
			if (accounts_sections !== null) {
				accounts_sections.addEventListener('click', function (event) {
					const account = event.target.closest('.account');
					if (account) {
						document.querySelector('.active-account').innerHTML = account.innerHTML;
						if (last_clicked_account) {
							last_clicked_account.classList.remove('text-dark', 'bg-white');
						}
						account.classList.add('text-dark', 'bg-white');
						last_clicked_account = event.target.closest('.account');
						if (window.innerWidth < 576) {
							section_left.classList.add('d-none');
							section_right.classList.remove('d-none');
						}
					}
				})
			}

		})
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
		crossorigin="anonymous"></script>

	<!-- Сущевтует три разных варианта подлкючения библиотеки socket на стороне клиента для файла index.html -->
	<!-- 1 - путь к библиотеке в инете (пока что используем этот вариант. Лучше использовать 2 или 3, но пока еще не нашел как сделать, чтобы работало для локального и удаленного сервера одинаково) -->
	<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
	<!-- <script src="/socket.io/socket.io.js"></script> -->
	<!-- <script src="node_modules/socket.io/client-dist/socket.io.js"></script> -->

	<script>
		// Создаем функцию получения шаблона сообщения, которую можно вызывать в разных местах программы
		function getMsgHtml(content, time, isYours = false) {
			const wrapClass = isYours ? "alert-dark" : "alert-light ms-auto";
			return `<div class="alert ${wrapClass}">
						<div class="text-break lh-sm">${content}</div>
						<div class="font-monospace text-end small">${time}</div>
					</div>`
		}

		// Создаем сокет чата на стороне клиента для файла index.html
		const socket = io(
			// 1 параметр - оригинальный адрес сайта на котором запускается чат
			window.location.origin,

			// 2 параметр - объект из разных свойств. В нашем случае передаем свойство "path" которое указывает дирекотрию/папку сайта в которой запускается файл index.html
			// !!! - к дериктории/папке добавляем строку "socket.io" (отсутствие этой строки не позволяло запускать чат на удаленном сервере)
			{
				path: window.location.pathname + 'socket.io'
			}
		);

		// Создаем константы для работы с формой, полем ввода сообщения, списком сообщений
		const form = document.getElementById('form');
		const input = document.getElementById('input');
		const messages = document.getElementById('messages');

		// !!! Для временного решения проблемы с дублированием сообщений из базы данных во вермя перезагрузки гл.файла создаем переменную areDbMessage  перед подключением к сокету. Есть другое решение данной проблемы - более правильное, но более сложное в реализации. Пока что такое решение - быстрое и простое)))
		let areDbMessages = false;
		// Со стороны клиента подключаемся к событию "db_messages" для получения всех сообщений из БД
		socket.on('db_messages', (dbMessages) => {
			// !!! Если переменна areDbMessages == false, то полученные сообщеия из БД записанные в dbMessages показываем на странице
			if (areDbMessages === false) {
				// Так как получаем массив сообщений, то нужно пропустить его через цикл, чтобы получить каждое сообщение в отдельности
				dbMessages.forEach(dbMsg => {
					// Используем шаблон сообщения и добалвяем его к другим сообщениям в чате
					messages.innerHTML += getMsgHtml(dbMsg.content, "12:00");
					// при появлении чата сразу скроллим к последнему сообщению
				});
				messages.scrollTo(0, 100000);
			}
			// !!! После того как показали на странице сообщения из БД, изменяем переменную areDbMessages = true
			// В случае перезапуска гл.файла index.js на сервере файл index.html остается без изменений и переменная areDbMessages продолжает быть true. А значит при перезапуске гл.файлa index.js, который отправляет сообщения из БД в index.html условие if не исполнится, т.к. areDbMessages == true и значит не показываем в index.html полученные сообщения из БД. Хотя код из index.js отправляет все сообщения повторно для index.html и в dbMessages каждый раз присылаются сообщения при каждом перезапуске index.js. Тут просто блокируем повтороное отбражение сообщений из БД которые уже показаны на странце. Это только для режима разработки. Позже надо будет разрешить данную проблему иначе, более профессионально, не присылая со строноы сервера сообщений, котороые не нужны для клиента)))
			areDbMessages = true;
		})

		// Подключаемся к событию отправки форм
		form.addEventListener('submit', (e) => {
			// отключаем событие по умолчанию
			e.preventDefault();
			// проверяем поле формы
			if (input.value) {
				// если поле формы не пустое
				// отправляем сообщение для события чата под именем "chat_message"(имя может быть любое)
				socket.emit('chat_message', input.value);
				// после отправки сообщения чистим поле для нового сообщения
				input.value = '';
			}
		});

		// подключаемся к событию чата chat_message
		// для получаения сообщеий от данного события
		socket.on('chat_message', (msg) => {
			// при получении сообщения от сервера добавляем сообщения к другим сообщениям в чате используя шаблон сообщения
			messages.innerHTML += getMsgHtml(msg, "12:00");
			// скролим экран к последнему сообщению (пока что показатель 100000)
			messages.scrollTo(0, 100000);
		});

		socket.on("connect_error", (err) => {
			console.log(err.message);
			console.log(err.description);
			console.log(err.context);
		});

	</script>
</body>

</html>